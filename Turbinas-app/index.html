<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Inspecci√≥n de Turbinas</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f2f5; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.25rem; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; margin-top: 1rem; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .inspection-card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    img.preview { max-width: 100px; margin-right: 0.5rem; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>üîß Sistema de Inspecci√≥n de Turbinas</h1>
  <div id="connectionStatus"></div>
  <div class="form-group">
    <label>URL de Supabase</label>
    <input type="text" id="supabaseUrl" placeholder="https://xyzcompany.supabase.co" />
  </div>
  <div class="form-group">
    <label>Clave p√∫blica (anon key)</label>
    <input type="text" id="supabaseKey" placeholder="eyJ..." />
  </div>
  <button class="btn btn-primary" onclick="saveCredentials()">Guardar configuraci√≥n</button>

  <hr />
  <form id="inspectionForm">
    <h2>üìù Nueva Inspecci√≥n</h2>
    <div class="form-group"><label>Inspector</label><input type="text" id="inspector" required /></div>
    <div class="form-group"><label>Modelo</label><input type="text" id="modelo" required /></div>
    <div class="form-group"><label>Trazabilidad</label><input type="text" id="trazabilidad" required /></div>
    <div class="form-group">
      <label>Pieza</label>
      <select id="pieza" required>
        <option value="">Selecciona una</option>
        <option value="Fondo">Fondo</option>
        <option value="Carcasa">Carcasa</option>
        <option value="Buje">Buje</option>
      </select>
    </div>
    <div class="form-group">
      <label>Prioridad</label>
      <select id="prioridad" required>
        <option value="alta">Alta</option>
        <option value="media">Media</option>
        <option value="baja">Baja</option>
      </select>
    </div>
    <div class="form-group">
      <label>Observaciones</label>
      <textarea id="observaciones"></textarea>
    </div>
    <div class="form-group">
      <label>Fotos</label>
      <input type="file" id="fotos" multiple accept="image/*" />
    </div>
    <button class="btn btn-success" type="submit">Guardar Inspecci√≥n</button>
  </form>

  <hr />
  <h2>üìã Historial</h2>
  <div id="inspectionsList"></div>

  <script>
    let supabase = null;

    function saveCredentials() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();
      if (url && key) {
        localStorage.setItem('supabase_url', url);
        localStorage.setItem('supabase_key', key);
        initSupabase();
      }
    }

    function initSupabase() {
      const url = localStorage.getItem('supabase_url');
      const key = localStorage.getItem('supabase_key');
      if (url && key) {
        supabase = window.supabase.createClient(url, key);
        document.getElementById('connectionStatus').textContent = '‚úÖ Conectado a Supabase';
        loadInspections();
      } else {
        document.getElementById('connectionStatus').textContent = '‚ùå No conectado';
      }
    }

    async function uploadPhotos(photos, inspectionId) {
      const uploaded = [];
      for (const file of photos) {
        const filePath = `${inspectionId}/${file.name}`;
        const { data, error } = await supabase.storage.from('fotos').upload(filePath, file, {
          cacheControl: '3600', upsert: true
        });
        if (!error) {
          const { data: publicUrl } = supabase.storage.from('fotos').getPublicUrl(filePath);
          uploaded.push({ inspeccion_id: inspectionId, nombre_archivo: file.name, url_archivo: publicUrl.publicUrl });
        }
      }
      if (uploaded.length > 0) {
        await supabase.from('fotos').insert(uploaded);
      }
    }

    document.getElementById('inspectionForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = {
        inspector: document.getElementById('inspector').value,
        modelo: document.getElementById('modelo').value,
        trazabilidad: document.getElementById('trazabilidad').value,
        pieza: document.getElementById('pieza').value,
        prioridad: document.getElementById('prioridad').value,
        observaciones: document.getElementById('observaciones').value,
        completado: false
      };

      const { data, error } = await supabase.from('inspecciones').insert([formData]).select();
      if (error) return alert('‚ùå Error al guardar inspecci√≥n');

      const inspectionId = data[0].id;
      const photos = document.getElementById('fotos').files;
      if (photos.length > 0) await uploadPhotos(photos, inspectionId);

      alert('‚úÖ Inspecci√≥n guardada');
      document.getElementById('inspectionForm').reset();
      loadInspections();
    });

    async function markCompleted(id) {
      await supabase.from('inspecciones').update({ completado: true }).eq('id', id);
      loadInspections();
    }

    async function loadInspections() {
      const list = document.getElementById('inspectionsList');
      const { data, error } = await supabase.from('inspecciones').select('*').order('created_at', { ascending: false });
      if (error) return list.innerHTML = '<p>Error cargando inspecciones</p>';
      list.innerHTML = '';

      for (const insp of data) {
        const { data: fotos } = await supabase.from('fotos').select('*').eq('inspeccion_id', insp.id);
        const card = document.createElement('div');
        card.className = 'inspection-card';
        card.innerHTML = `
          <strong>${insp.inspector}</strong> ‚Äì ${insp.modelo} (${insp.pieza})<br>
          <em>Prioridad:</em> ${insp.prioridad}<br>
          <em>Observaciones:</em> ${insp.observaciones || 'Ninguna'}<br>
          <div style="margin: 0.5rem 0;">${fotos?.map(f => `<img class="preview" src="${f.url_archivo}" />`).join('')}</div>
          ${insp.completado ? '<b>‚úÖ Reparaci√≥n completada</b>' : `<button class="btn btn-primary" onclick="markCompleted(${insp.id})">Marcar como completada</button>`}
        `;
        list.appendChild(card);
      }
    }

    window.addEventListener('DOMContentLoaded', initSupabase);
  </script>
</body>
</html>
