<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Tu HTML y CSS aqu√≠ -->

  <script>
    let inspectionsList = [];
    let connectionStatus = 'disconnected';
    let supabase;

    const DB_CONFIG = {
      url: 'https://your-project.supabase.co',
      key: 'your-anon-key-here'
    };

    const DEVICE_ID = getDeviceId();

    function getDeviceId() {
      let deviceId = localStorage.getItem('turbine_device_id');
      if (!deviceId) {
        deviceId = 'turbine_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('turbine_device_id', deviceId);
      }
      return deviceId;
    }

    async function connectToDatabase() {
      try {
        supabase = window.supabase.createClient(DB_CONFIG.url, DB_CONFIG.key);

        const { error } = await supabase
          .from('inspecciones')
          .select('id')
          .limit(1);

        if (error) throw error;
        connectionStatus = 'connected';
      } catch (err) {
        connectionStatus = 'disconnected';
        throw err;
      }
    }

    async function loadInspections() {
      const container = document.getElementById('inspectionsList');
      container.innerHTML = '<div class="loading">‚è≥ Cargando inspecciones...</div>';

      try {
        const { data, error } = await supabase
          .from('inspecciones')
          .select('*, fotos(*)')
          .order('created_at', { ascending: false });

        if (error) throw error;

        inspectionsList = data;

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="status info">‚ÑπÔ∏è No hay inspecciones registradas</div>';
          return;
        }

        container.innerHTML = data.map(inspection => `
          <div class="inspection-card">
            <div class="inspection-header">
              <strong>${inspection.modelo}</strong>
              <span class="priority-badge priority-${inspection.prioridad}">
                ${inspection.prioridad.toUpperCase()}
              </span>
            </div>
            <div class="inspection-date">üìÖ ${new Date(inspection.created_at).toLocaleString()}</div>
            <div><strong>Inspector:</strong> ${inspection.inspector}</div>
            <div><strong>Pieza:</strong> ${inspection.pieza}</div>
            <div><strong>Trazabilidad:</strong> ${inspection.trazabilidad}</div>
            <div><strong>Observaciones:</strong> ${inspection.observaciones}</div>
            <div><strong>Fotos:</strong>
              <div class="photo-gallery">
                ${inspection.fotos?.map(f => `<img src="${f.contenido_base64}" onclick="openPhotoModal('${f.contenido_base64}')">`).join('') || 'No hay fotos'}
              </div>
            </div>
            <div style="margin-top: 10px;">
              <button class="btn btn-success" onclick="markAsCompleted(${inspection.id})">‚úÖ Marcar como Completado</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error cargando inspecciones:', err);
        container.innerHTML = '<div class="status error">‚ùå No se pudieron cargar las inspecciones</div>';
      }
    }

    async function markAsCompleted(id) {
      try {
        const { error } = await supabase
          .from('inspecciones')
          .update({ completado: true })
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Reparaci√≥n marcada como completada');
        loadInspections();
      } catch (err) {
        console.error('Error marcando como completado:', err);
        alert('‚ùå No se pudo completar');
      }
    }

    function exportData() {
      if (!inspectionsList.length) {
        alert('‚ö†Ô∏è No hay datos para exportar');
        return;
      }

      const csvHeader = ['Inspector', 'Modelo', 'Trazabilidad', 'Pieza', 'Prioridad', 'Observaciones', 'Fecha'];
      const csvRows = inspectionsList.map(i => [
        i.inspector,
        i.modelo,
        i.trazabilidad,
        i.pieza,
        i.prioridad,
        `"${i.observaciones?.replace(/"/g, '""') || ''}"`,
        new Date(i.created_at).toLocaleString()
      ]);

      const csvContent = [csvHeader, ...csvRows].map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.setAttribute('download', 'inspecciones.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function updateSystemStatus() {
      const statusDiv = document.getElementById('systemStatus');
      const statsDiv = document.getElementById('systemStats');
      try {
        const { count } = await supabase
          .from('inspecciones')
          .select('*', { count: 'exact' });

        statusDiv.innerHTML = `
          <div><strong>üì° Dispositivo ID:</strong> ${DEVICE_ID}</div>
          <div><strong>üîå Estado de Conexi√≥n:</strong> ${connectionStatus.toUpperCase()}</div>
        `;

        statsDiv.innerHTML = `
          <div><strong>üìã Inspecciones Registradas:</strong> ${count}</div>
          <div><strong>üïí √öltima actualizaci√≥n:</strong> ${new Date().toLocaleString()}</div>
        `;
      } catch (err) {
        statusDiv.innerHTML = '<div class="status error">‚ùå Error al obtener estado del sistema</div>';
      }
    }

    async function initializeApp() {
      try {
        await connectToDatabase();
        // setupEventListeners(); <-- agregar si existe esta funci√≥n
        updateConnectionStatus();
        loadInspections();
      } catch (error) {
        console.error('Error inicializando aplicaci√≥n:', error);
        updateConnectionStatus('error');
      }
    }

    function updateConnectionStatus() {
      const statusBar = document.getElementById('connectionStatusBar');
      if (connectionStatus === 'connected') {
        statusBar.className = 'connection-status connected';
        statusBar.textContent = '‚úÖ Conectado - Sistema listo para usar';
      } else {
        statusBar.className = 'connection-status disconnected';
        statusBar.textContent = '‚ùå Sin conexi√≥n - Verifica tu internet';
      }
    }

    initializeApp();
  </script>
</body>
</html>
