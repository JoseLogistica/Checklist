<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Head intacto -->
</head>
<body>
  <!-- Tu c√≥digo HTML y CSS permanece igual, sin cambios -->

  <!-- Donde termina tu √∫ltimo script -->
  <script>
    // Aqu√≠ se agregan las nuevas funciones que completan el sistema

    let inspectionsList = [];
    let connectionStatus = 'disconnected';

    async function loadInspections() {
      const container = document.getElementById('inspectionsList');
      container.innerHTML = '<div class="loading">‚è≥ Cargando inspecciones...</div>';

      try {
        const { data, error } = await supabase
          .from('inspecciones')
          .select('*, fotos(*)')
          .order('created_at', { ascending: false });

        if (error) throw error;

        inspectionsList = data;

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="status info">‚ÑπÔ∏è No hay inspecciones registradas</div>';
          return;
        }

        container.innerHTML = data.map(inspection => `
          <div class="inspection-card">
            <div class="inspection-header">
              <strong>${inspection.modelo}</strong>
              <span class="priority-badge priority-${inspection.prioridad}">
                ${inspection.prioridad.toUpperCase()}
              </span>
            </div>
            <div class="inspection-date">üìÖ ${new Date(inspection.created_at).toLocaleString()}</div>
            <div><strong>Inspector:</strong> ${inspection.inspector}</div>
            <div><strong>Pieza:</strong> ${inspection.pieza}</div>
            <div><strong>Trazabilidad:</strong> ${inspection.trazabilidad}</div>
            <div><strong>Observaciones:</strong> ${inspection.observaciones}</div>
            <div><strong>Fotos:</strong>
              <div class="photo-gallery">
                ${inspection.fotos?.map(f => `<img src="${f.contenido_base64}" onclick="openPhotoModal('${f.contenido_base64}')">`).join('') || 'No hay fotos'}
              </div>
            </div>
            <div style="margin-top: 10px;">
              <button class="btn btn-success" onclick="markAsCompleted(${inspection.id})">‚úÖ Marcar como Completado</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error cargando inspecciones:', err);
        container.innerHTML = '<div class="status error">‚ùå No se pudieron cargar las inspecciones</div>';
      }
    }

    async function markAsCompleted(id) {
      try {
        const { error } = await supabase
          .from('inspecciones')
          .update({ completado: true })
          .eq('id', id);

        if (error) throw error;
        alert('‚úÖ Reparaci√≥n marcada como completada');
        loadInspections();
      } catch (err) {
        console.error('Error marcando como completado:', err);
        alert('‚ùå No se pudo completar');
      }
    }

    function exportData() {
      if (!inspectionsList.length) {
        alert('‚ö†Ô∏è No hay datos para exportar');
        return;
      }

      const csvHeader = ['Inspector', 'Modelo', 'Trazabilidad', 'Pieza', 'Prioridad', 'Observaciones', 'Fecha'];
      const csvRows = inspectionsList.map(i => [
        i.inspector,
        i.modelo,
        i.trazabilidad,
        i.pieza,
        i.prioridad,
        `"${i.observaciones?.replace(/"/g, '""') || ''}"`,
        new Date(i.created_at).toLocaleString()
      ]);

      const csvContent = [csvHeader, ...csvRows].map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.setAttribute('download', 'inspecciones.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function updateSystemStatus() {
      const statusDiv = document.getElementById('systemStatus');
      const statsDiv = document.getElementById('systemStats');
      try {
        const { count } = await supabase
          .from('inspecciones')
          .select('*', { count: 'exact' });

        statusDiv.innerHTML = `
          <div><strong>üì° Dispositivo ID:</strong> ${DEVICE_ID}</div>
          <div><strong>üîå Estado de Conexi√≥n:</strong> ${connectionStatus.toUpperCase()}</div>
        `;

        statsDiv.innerHTML = `
          <div><strong>üìã Inspecciones Registradas:</strong> ${count}</div>
          <div><strong>üïí √öltima actualizaci√≥n:</strong> ${new Date().toLocaleString()}</div>
        `;
      } catch (err) {
        statusDiv.innerHTML = '<div class="status error">‚ùå Error al obtener estado del sistema</div>';
      }
    }

    async function initializeApp() {
      try {
        await connectToDatabase();
        setupEventListeners();
        updateConnectionStatus();
        loadInspections();
      } catch (error) {
        console.error('Error inicializando aplicaci√≥n:', error);
        updateConnectionStatus('error');
      }
    }

    initializeApp();
  </script>
</body>
</html>
